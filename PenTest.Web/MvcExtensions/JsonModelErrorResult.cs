using System.Linq;
using System.Net;
using System.Web.Mvc;

namespace PenTest.Web.MvcExtensions
{
    public class JsonModelErrorResult : JsonNetResult
    {
        private readonly ModelStateDictionary _state;

        public JsonModelErrorResult(ModelStateDictionary state)
        {
            this._state = state;
        }

        public override void ExecuteResult(ControllerContext context)
        {
            if (!this._state.IsValid)
                this.AppendModelErrrors();
            base.ExecuteResult(context);
        }

        private void AppendModelErrrors()
        {
            this.ContentType = string.Empty; // let the base class append the content type
            this.StatusCode = HttpStatusCode.BadRequest;
            this.StatusDescription = "Input Rejected";

            this.Data = (from item in this._state
                from error in item.Value.Errors
                select new { Property = item.Key, Message = error.ErrorMessage }).ToList();
        }

    }
}